// prisma/schema.prisma
// Compatible with PostgreSQL (dev) and MySQL (future desktop offline)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//// ENUMS

enum UserRole {
  OWNER
  CASHIER
}

enum UnitType {
  UNIT // unidad
  KG // kilogramo
}

enum MovementType {
  SALE
  PURCHASE
  ADJUSTMENT
}

enum PaymentMethod {
  CASH
  YAPE
  PLIN
  CARD
  FIADO
}

enum ReceivableStatus {
  OPEN
  PAID
  CANCELLED
}

enum StoreStatus {
  ACTIVE
  ARCHIVED
}

enum DiscountType {
  PERCENT
  AMOUNT
}

enum PromotionType {
  TWO_FOR_ONE
  PACK_PRICE
  HAPPY_HOUR
}

enum CouponType {
  PERCENT
  AMOUNT
}

enum VolumePromoType {
  FIXED_PRICE
}

enum NthPromoType {
  NTH_PERCENT   // 2do al 50%, 3ro al 100%, etc.
}

enum PlanCode {
  DEMO
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELLED
}

//// MODELS

model Store {
  id         String      @id @default(cuid())
  name       String
  ruc        String?
  address    String?
  phone      String?
  status     StoreStatus @default(ACTIVE)
  archivedAt DateTime?   @map("archived_at")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  users         User[]
  storeProducts StoreProduct[]
  sales         Sale[]
  shifts        Shift[]
  movements     Movement[]
  settings      StoreSettings?
  customers     Customer[] // ✅ Clientes de la tienda
  receivables   Receivable[] // ✅ Cuentas por cobrar
  promotions         Promotion[] // ✅ Promociones de la tienda
  coupons            Coupon[] // ✅ Cupones de la tienda
  categoryPromotions CategoryPromotion[] // ✅ Promociones por categoría (14.2-B)
  volumePromotions   VolumePromotion[] // ✅ Promociones por volumen (14.2-C1)
  nthPromotions      NthPromotion[] // ✅ Promociones n-ésimo con descuento (14.2-C2)
  auditLogs          AuditLog[] // ✅ MÓDULO 15: Auditoría
  featureFlags       FeatureFlag[] // ✅ MÓDULO 15: Feature Flags (Fase 2)
  operationalLimit   OperationalLimit? // ✅ MÓDULO 15: Límites Operativos (Fase 3)
  subscription       Subscription? // ✅ MÓDULO 16: Licencia y Suscripción
  payments           Payment[] // ✅ MÓDULO 16: Historial de pagos

  @@map("stores")
}

model User {
  id        String   @id @default(cuid())
  storeId   String   @map("store_id")
  email     String   @unique
  name      String
  password  String // hashed in module 2
  role      UserRole
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shifts relations
  openedShifts Shift[] @relation("ShiftOpenedBy")
  closedShifts Shift[] @relation("ShiftClosedBy")

  // Sales relation (cashier)
  sales Sale[]

  // Movements created by user
  movements Movement[]

  // Receivables created
  receivablesCreated Receivable[]        @relation("ReceivableCreatedBy")
  receivablePayments ReceivablePayment[] @relation("PaymentCreatedBy")
  
  // MÓDULO 15: Auditoría
  auditLogs AuditLog[]

  @@index([storeId])
  @@map("users")
}

// Catálogo maestro
model ProductMaster {
  id          String   @id @default(cuid())
  barcode     String?  @unique // Nullable para productos sin código
  internalSku String   @unique @map("internal_sku")
  name        String
  brand       String?
  content     String? // Ej: "500 ml", "1 kg"
  category    String   @default("Otros")
  unitType    UnitType @map("unit_type") // ✅ unitType pertenece al producto
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  storeProducts StoreProduct[]
  promotions    Promotion[] // ✅ Promociones del producto
  nthPromotions NthPromotion[] // ✅ Promociones n-ésimo con descuento del producto
  volumePromotions VolumePromotion[] // ✅ Promociones por volumen del producto

  @@index([barcode])
  @@index([name])
  @@index([internalSku])
  @@map("products_master")
}

// Precio/stock por tienda
model StoreProduct {
  id        String @id @default(cuid())
  storeId   String @map("store_id")
  productId String @map("product_id")

  price    Decimal  @db.Decimal(10, 2)
  stock    Decimal? @db.Decimal(10, 3) // null permitido (ej: kg sin control)
  minStock Decimal? @map("min_stock") @db.Decimal(10, 3)

  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)

  saleItems SaleItem[]
  movements Movement[]

  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
  @@map("store_products")
}

// Turnos / Corte de caja
model Shift {
  id      String @id @default(cuid())
  storeId String @map("store_id")

  openedById String  @map("opened_by")
  closedById String? @map("closed_by")

  openedAt DateTime  @default(now()) @map("opened_at")
  closedAt DateTime? @map("closed_at")

  openingCash Decimal  @map("opening_cash") @db.Decimal(10, 2)
  closingCash Decimal? @map("closing_cash") @db.Decimal(10, 2)

  expectedCash Decimal? @map("expected_cash") @db.Decimal(10, 2)
  difference   Decimal? @db.Decimal(10, 2)

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  openedBy User  @relation("ShiftOpenedBy", fields: [openedById], references: [id], onDelete: Cascade)
  closedBy User? @relation("ShiftClosedBy", fields: [closedById], references: [id], onDelete: SetNull)

  sales              Sale[]
  receivablePayments ReceivablePayment[] // ✅ Pagos de FIADO en este turno

  @@index([storeId, openedAt])
  @@map("shifts")
}

// Venta (cabecera)
model Sale {
  id         String  @id @default(cuid())
  storeId    String  @map("store_id")
  userId     String  @map("user_id") // cashier
  shiftId    String? @map("shift_id")
  customerId String? @map("customer_id") // ✅ Para ventas FIADO

  saleNumber Int @map("sale_number") // correlativo por tienda

  subtotal Decimal @db.Decimal(10, 2) // total sin impuestos (o antes de tax)
  tax      Decimal @db.Decimal(10, 2) // puede ser 0
  total    Decimal @db.Decimal(10, 2)

  // Descuentos (Módulo 14)
  discountTotal        Decimal @default(0) @map("discount_total") @db.Decimal(10, 2)
  totalBeforeDiscount  Decimal @default(0) @map("total_before_discount") @db.Decimal(10, 2)

  // Cupones (Módulo 14.2-A) - Snapshot
  couponCode          String?     @map("coupon_code")
  couponType          CouponType? @map("coupon_type")
  couponValue         Decimal?    @map("coupon_value") @db.Decimal(10, 2)
  couponDiscount      Decimal     @default(0) @map("coupon_discount") @db.Decimal(10, 2)
  totalBeforeCoupon   Decimal     @default(0) @map("total_before_coupon") @db.Decimal(10, 2)

  paymentMethod PaymentMethod @map("payment_method")
  amountPaid    Decimal?      @map("amount_paid") @db.Decimal(10, 2) // efectivo
  changeAmount  Decimal?      @map("change_amount") @db.Decimal(10, 2) // vuelto

  printedAt DateTime? @map("printed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shift    Shift?    @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  items      SaleItem[]
  receivable Receivable? // ✅ Relación uno a uno con cuenta por cobrar

  @@unique([storeId, saleNumber])
  @@index([storeId, createdAt])
  @@index([customerId])
  @@map("sales")
}

// Detalle de venta (snapshot)
model SaleItem {
  id             String @id @default(cuid())
  saleId         String @map("sale_id")
  storeProductId String @map("store_product_id")

  // Snapshot para que el ticket histórico no cambie si editas el producto luego
  productName    String   @map("product_name")
  productContent String?  @map("product_content")
  unitType       UnitType @map("unit_type")

  quantity  Decimal @db.Decimal(10, 3)
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  // Descuentos (Módulo 14)
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal?      @map("discount_value") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalLine      Decimal       @default(0) @map("total_line") @db.Decimal(10, 2)

  // Promociones (Módulo 14.1) - Snapshot
  promotionType     PromotionType? @map("promotion_type")
  promotionName     String?        @map("promotion_name")
  promotionDiscount Decimal        @default(0) @map("promotion_discount") @db.Decimal(10, 2)

  // Promociones por Categoría (Módulo 14.2-B) - Snapshot
  categoryPromoName     String?       @map("category_promo_name")
  categoryPromoType     DiscountType? @map("category_promo_type")
  categoryPromoDiscount Decimal       @default(0) @map("category_promo_discount") @db.Decimal(10, 2)

  // Promociones por Volumen (Módulo 14.2-C1) - Snapshot
  volumePromoName     String? @map("volume_promo_name")
  volumePromoQty      Int?    @map("volume_promo_qty")
  volumePromoDiscount Decimal @default(0) @map("volume_promo_discount") @db.Decimal(10, 2)
// Promociones N-ésimo con Descuento (Módulo 14.2-C2) - Snapshot
  nthPromoName     String?  @map("nth_promo_name")
  nthPromoQty      Int?     @map("nth_promo_qty")
  nthPromoPercent  Decimal? @map("nth_promo_percent") @db.Decimal(5, 2)
  nthPromoDiscount Decimal  @default(0) @map("nth_promo_discount") @db.Decimal(10, 2)

  
  sale         Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([storeProductId])
  @@map("sale_items")
}

// Movimientos (inventario / auditoría)
model Movement {
  id             String       @id @default(cuid())
  storeId        String       @map("store_id")
  storeProductId String       @map("store_product_id")
  type           MovementType

  quantity  Decimal  @db.Decimal(10, 3)
  unitPrice Decimal? @map("unit_price") @db.Decimal(10, 2)
  total     Decimal? @db.Decimal(10, 2)

  notes       String?
  createdById String? @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store        Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([storeProductId, createdAt])
  @@map("movements")
}

// Configuración por tienda (ticket, impuestos, etc.)
model StoreSettings {
  id      String @id @default(cuid())
  storeId String @unique @map("store_id")

  // Configuración de ticket
  ticketFooter      String? @map("ticket_footer") @db.Text
  ticketHeaderLine1 String? @map("ticket_header_line1") @db.VarChar(100) // ej: "Bodega X"
  ticketHeaderLine2 String? @map("ticket_header_line2") @db.VarChar(100) // ej: "RUC: ..."
  taxRate           Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)

  // ✅ MÓDULO 16.2: Onboarding
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  onboardingStep        Int       @default(0) @map("onboarding_step") // 0-6
  onboardingDismissedAt DateTime? @map("onboarding_dismissed_at")
  defaultPaymentMethod  PaymentMethod @default(CASH) @map("default_payment_method")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("store_settings")
}

// ✅ MÓDULO 12: CLIENTES + FIADO

// Clientes
model Customer {
  id      String  @id @default(cuid())
  storeId String  @map("store_id")
  name    String
  phone   String?
  dni     String?
  notes   String?
  active  Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sales       Sale[]
  receivables Receivable[]

  @@index([storeId, name])
  @@map("customers")
}

// Cuenta por cobrar (una por venta FIADO)
model Receivable {
  id             String           @id @default(cuid())
  storeId        String           @map("store_id")
  customerId     String           @map("customer_id")
  saleId         String           @unique @map("sale_id") // ✅ Uno a uno
  originalAmount Decimal          @map("original_amount") @db.Decimal(10, 2)
  balance        Decimal          @db.Decimal(10, 2) // Saldo pendiente
  status         ReceivableStatus @default(OPEN)
  createdById    String           @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store     Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer  Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sale      Sale                @relation(fields: [saleId], references: [id], onDelete: Cascade)
  createdBy User                @relation("ReceivableCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  payments  ReceivablePayment[]

  @@index([storeId, status])
  @@index([customerId])
  @@map("receivables")
}

// Pagos de cuentas por cobrar (abonos)
model ReceivablePayment {
  id           String        @id @default(cuid())
  storeId      String        @map("store_id")
  receivableId String        @map("receivable_id")
  shiftId      String        @map("shift_id") // ✅ Turno en el que se cobró
  amount       Decimal       @db.Decimal(10, 2)
  method       PaymentMethod // CASH, YAPE, PLIN, CARD
  notes        String?
  createdById  String        @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")

  receivable Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  shift      Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  createdBy  User       @relation("PaymentCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([receivableId])
  @@index([shiftId])
  @@index([storeId, createdAt])
  @@map("receivable_payments")
}

// Promociones (2x1, pack price, happy hour, fechas especiales)
model Promotion {
  id        String        @id @default(cuid())
  storeId   String        @map("store_id")
  type      PromotionType
  name      String
  active    Boolean       @default(true)

  // Producto objetivo
  productId String? @map("product_id")

  // Reglas de cantidad
  minQty Int? @map("min_qty")

  // Pack price
  packPrice Decimal? @map("pack_price") @db.Decimal(10, 2)

  // Happy hour
  happyStart DateTime? @map("happy_start")
  happyEnd   DateTime? @map("happy_end")
  happyPrice Decimal?  @map("happy_price") @db.Decimal(10, 2)

  // Vigencia general (fechas especiales)
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([productId])
  @@map("promotions")
}

// Cupones por código (NAVIDAD10, MAMA5, etc.)
model Coupon {
  id        String     @id @default(cuid())
  storeId   String     @map("store_id")
  code      String
  type      CouponType
  value     Decimal    @db.Decimal(10, 2) // 10 (%) o 5.00 (S/)
  minTotal  Decimal?   @map("min_total") @db.Decimal(10, 2) // mínimo de compra
  startsAt  DateTime?  @map("starts_at")
  endsAt    DateTime?  @map("ends_at")
  maxUses   Int?       @map("max_uses") // null = ilimitado
  usesCount Int        @default(0) @map("uses_count")
  active    Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, code])
  @@index([storeId, active])
  @@map("coupons")
}

// Promociones por Categoría (Módulo 14.2-B)
model CategoryPromotion {
  id       String       @id @default(cuid())
  storeId  String       @map("store_id")
  name     String
  category String // coincide con ProductMaster.category (case-insensitive)
  type     DiscountType // PERCENT | AMOUNT
  value    Decimal      @db.Decimal(10, 2) // 10 (%) o 1.00 (S/)

  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  active   Boolean   @default(true)

  maxDiscountPerItem Decimal? @map("max_discount_per_item") @db.Decimal(10, 2) // opcional: tope por item

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([storeId, category])
  @@map("category_promotions")
}

// Promociones por Volumen / Pack Fijo (Módulo 14.2-C1)
model VolumePromotion {
  id          String           @id @default(cuid())
  storeId     String           @map("store_id")
  name        String
  productId   String           @map("product_id")
  type        VolumePromoType
  requiredQty Int              @map("required_qty") // Ej: 3
  packPrice   Decimal          @db.Decimal(10, 2) // Ej: 5.00

  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  active   Boolean   @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([storeId, productId])
  @@map("volume_promotions")
}

// Promociones N-ésimo con Descuento (Módulo 14.2-C2)
model NthPromotion {
  id          String       @id @default(cuid())
  storeId     String       @map("store_id")
  name        String
  productId   String       @map("product_id")
  
  type        NthPromoType
  nthQty      Int          @map("nth_qty") // N (2 = segundo, 3 = tercero)
  percentOff  Decimal      @map("percent_off") @db.Decimal(5, 2) // 50.00, 100.00, etc.
  
  startsAt    DateTime?    @map("starts_at")
  endsAt      DateTime?    @map("ends_at")
  active      Boolean      @default(true)
  
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  
  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([storeId, active])
  @@index([storeId, productId])
  @@map("nth_promotions")
}

//// MÓDULO 15 — AUDITORÍA

enum AuditSeverity {
  INFO
  WARN
  ERROR
}

enum AuditEntityType {
  SALE
  SHIFT
  COUPON
  PROMOTION
  STORE
  CUSTOMER
  RECEIVABLE
  USER
  PRODUCT
  RESTORE
  SYSTEM
  SUBSCRIPTION  // MÓDULO 16
  PAYMENT       // MÓDULO 16
}

model AuditLog {
  id         String           @id @default(cuid())
  createdAt  DateTime         @default(now()) @map("created_at")
  
  storeId    String?          @map("store_id") // nullable para acciones SUPERADMIN globales
  userId     String?          @map("user_id") // nullable si es sistema
  
  action     String // SALE_CHECKOUT_SUCCESS, SHIFT_OPENED, etc.
  entityType AuditEntityType  @map("entity_type")
  entityId   String?          @map("entity_id") // nullable
  severity   AuditSeverity    @default(INFO)
  
  meta       Json? // Datos adicionales sin info sensible
  ip         String? // IP del request
  userAgent  String?          @map("user_agent") // User-Agent del request
  
  store Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([storeId, createdAt])
  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

//// MÓDULO 15 — FEATURE FLAGS (Fase 2)

enum FeatureFlagKey {
  ALLOW_FIADO
  ALLOW_COUPONS
  ENABLE_PROMOTIONS
  ENABLE_VOLUME_PROMOS
  ENABLE_NTH_PROMOS
  ENABLE_CATEGORY_PROMOS
}

model FeatureFlag {
  id        String         @id @default(cuid())
  storeId   String         @map("store_id")
  key       FeatureFlagKey
  enabled   Boolean        @default(false) // ✅ Default seguro
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, key]) // Una flag por tienda
  @@index([storeId])
  @@map("feature_flags")
}

//// MÓDULO 15 — FASE 3: LÍMITES OPERATIVOS

model OperationalLimit {
  id        String   @id @default(cuid())
  storeId   String   @unique @map("store_id")
  
  // Límites de descuentos
  maxDiscountPercent      Decimal? @map("max_discount_percent") @db.Decimal(5, 2)
  maxManualDiscountAmount Decimal? @map("max_manual_discount_amount") @db.Decimal(10, 2)
  
  // Límites de ventas
  maxSaleTotal            Decimal? @map("max_sale_total") @db.Decimal(10, 2)
  maxItemsPerSale         Int?     @map("max_items_per_sale")
  
  // Límites de cuentas por cobrar
  maxReceivableBalance    Decimal? @map("max_receivable_balance") @db.Decimal(10, 2)
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@map("operational_limits")
}

//// MÓDULO 16 — LICENCIAS + SUSCRIPCIONES (SaaS)

model Subscription {
  id        String              @id @default(cuid())
  storeId   String              @unique @map("store_id")
  
  // Plan y estado
  planCode  PlanCode            @map("plan_code")
  status    SubscriptionStatus  @default(TRIAL)
  
  // Fechas críticas
  startAt             DateTime  @default(now()) @map("start_at")
  trialEndsAt         DateTime? @map("trial_ends_at")
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  graceEndsAt         DateTime? @map("grace_ends_at")
  suspendedAt         DateTime? @map("suspended_at")
  cancelledAt         DateTime? @map("cancelled_at")
  
  // Precio congelado para esta tienda
  priceAmount   Decimal @map("price_amount") @db.Decimal(10, 2)
  priceCurrency String  @default("PEN") @map("price_currency")
  billingCycle  String  @default("MONTHLY") @map("billing_cycle") // MONTHLY | YEARLY
  
  // Notas internas (soporte)
  notes String?
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  payments Payment[]
  
  @@index([storeId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id             String   @id @default(cuid())
  storeId        String   @map("store_id")
  subscriptionId String   @map("subscription_id")
  
  // Monto del pago
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("PEN")
  
  // Registro del pago
  paidAt    DateTime @map("paid_at")
  method    String // YAPE | PLIN | TRANSFER | CARD | etc
  reference String? // Número de operación
  status    String  @default("CONFIRMED") // CONFIRMED | REJECTED | PENDING
  
  // Auditoría: quién registró el pago
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  store        Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([storeId])
  @@index([subscriptionId])
  @@map("payments")
}
