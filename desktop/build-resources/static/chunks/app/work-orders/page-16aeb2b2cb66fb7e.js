(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8268],{7627:(e,a,s)=>{Promise.resolve().then(s.bind(s,8890))},2423:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]])},8867:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},1594:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},9191:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]])},3473:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},1466:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},2792:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(7401).A)("wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z",key:"1ngwbx"}]])},8890:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>v});var t=s(5155),r=s(2115),l=s(6046),n=s(9445),o=s(1594);let i=(0,s(7401).A)("clipboard-list",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);var c=s(3473),d=s(853),x=s(1466),m=s(2423),h=s(719),g=s(2792),u=s(4081),b=s(8867),p=s(9191),y=s(8474),j=s(6967),f=s(814),N=s(5273);let w={DRAFT:{label:"Borrador",color:"text-gray-700",bgColor:"bg-gray-100"},APPROVED:{label:"Aprobado",color:"text-blue-700",bgColor:"bg-blue-100"},IN_PROGRESS:{label:"En Proceso",color:"text-yellow-700",bgColor:"bg-yellow-100"},READY:{label:"Listo",color:"text-green-700",bgColor:"bg-green-100"},CLOSED:{label:"Cerrado",color:"text-purple-700",bgColor:"bg-purple-100"},CANCELLED:{label:"Cancelado",color:"text-red-700",bgColor:"bg-red-100"}};function v(){let e=(0,l.useRouter)(),[a,s]=(0,r.useState)([]),[v,A]=(0,r.useState)(!0),[k,C]=(0,r.useState)(null),[E,S]=(0,r.useState)(""),[R,P]=(0,r.useState)(""),[O,D]=(0,r.useState)(null),[F,L]=(0,r.useState)(!1),[M,T]=(0,r.useState)(!1),[V,_]=(0,r.useState)("CASH"),[I,H]=(0,r.useState)(""),{isOn:z,isLoading:G}=(0,N.D0)(),Y=z("ENABLE_WORK_ORDERS");(0,r.useEffect)(()=>{fetch("/api/auth/me").then(e=>e.json()).then(e=>{if(e.error){window.location.href="/login";return}C(e)}).catch(()=>{window.location.href="/login"})},[]);let q=(0,r.useCallback)(async()=>{A(!0);try{let e=new URLSearchParams;E&&e.set("status",E),R.trim()&&e.set("q",R.trim());let a=await fetch("/api/work-orders?".concat(e.toString()));if(!a.ok)throw Error("Error al cargar \xf3rdenes");let t=await a.json();s(t.data||[])}catch(e){console.error("Error loading work orders:",e),f.oR.error("Error al cargar \xf3rdenes de trabajo")}finally{A(!1)}},[E,R]);(0,r.useEffect)(()=>{k&&Y&&!G&&q()},[k,Y,G,q]);let B=async(e,a)=>{try{let s=await fetch("/api/work-orders",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,status:a})});if(!s.ok){let e=await s.json();throw Error(e.error||"Error al actualizar")}f.oR.success("Estado actualizado a ".concat(w[a].label)),q()}catch(e){f.oR.error(e.message||"Error al actualizar estado")}},J=async()=>{if(O){if("CASH"===V){let e=parseFloat(I);if(isNaN(e)||e<O.total){f.oR.error("Monto pagado insuficiente");return}}T(!0);try{let e={paymentMethod:V};"CASH"===V&&(e.amountPaid=parseFloat(I));let a=await fetch("/api/work-orders/".concat(O.id,"/convert-to-sale"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok){let e=await a.json();throw Error(e.error||"Error al convertir")}let s=await a.json();f.oR.success("Venta #".concat(s.data.saleNumber," creada exitosamente")),L(!1),D(null),q()}catch(e){f.oR.error(e.message||"Error al convertir orden")}finally{T(!1)}}},K=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e),U=e=>new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"short",year:"numeric"});return G?(0,t.jsx)(n.A,{children:(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"})})}):Y?(0,t.jsxs)(n.A,{children:[(0,t.jsx)(f.l$,{position:"top-right",richColors:!0}),(0,t.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[(0,t.jsx)(i,{className:"w-7 h-7 text-blue-600"}),"\xd3rdenes de Trabajo"]}),(0,t.jsx)("p",{className:"text-gray-500 mt-1",children:"Cotizaciones y pedidos especiales (cortes, instalaciones, trabajos)"})]}),(0,t.jsxs)("button",{onClick:()=>e.push("/work-orders/new"),className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:[(0,t.jsx)(c.A,{className:"w-5 h-5"}),"Nueva Orden"]})]}),(0,t.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4",children:[(0,t.jsxs)("div",{className:"flex-1 relative",children:[(0,t.jsx)(d.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),(0,t.jsx)("input",{type:"text",placeholder:"Buscar por n\xfamero, cliente...",value:R,onChange:e=>P(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("select",{value:E,onChange:e=>S(e.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[(0,t.jsx)("option",{value:"",children:"Todos los estados"}),Object.entries(w).map(e=>{let[a,s]=e;return(0,t.jsx)("option",{value:a,children:s.label},a)})]})]})}),(0,t.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6",children:Object.entries(w).map(e=>{let[s,r]=e,l=a.filter(e=>e.status===s).length;return(0,t.jsxs)("button",{onClick:()=>S(s),className:"p-4 rounded-lg border ".concat(E===s?"border-blue-500 ring-2 ring-blue-200":"border-gray-200 hover:border-gray-300"," bg-white transition-all"),children:[(0,t.jsx)("div",{className:"text-2xl font-bold ".concat(r.color),children:l}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:r.label})]},s)})}),(0,t.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:v?(0,t.jsxs)("div",{className:"p-8 text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),(0,t.jsx)("p",{className:"text-gray-500 mt-3",children:"Cargando \xf3rdenes..."})]}):0===a.length?(0,t.jsxs)("div",{className:"p-8 text-center text-gray-500",children:[(0,t.jsx)(i,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),(0,t.jsx)("p",{className:"text-lg font-medium",children:"No hay \xf3rdenes de trabajo"}),(0,t.jsx)("p",{className:"text-sm mt-1",children:R||E?"No se encontraron resultados":"Crea tu primera orden para comenzar"})]}):(0,t.jsx)("div",{className:"divide-y divide-gray-200",children:a.map(a=>{let s=w[a.status],r=["APPROVED","IN_PROGRESS","READY"].includes(a.status)&&!a.sale;return(0,t.jsx)("div",{className:"p-4 hover:bg-gray-50 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,t.jsxs)("span",{className:"text-lg font-bold text-gray-900",children:["OT #",a.number]}),(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full ".concat(s.bgColor," ").concat(s.color),children:s.label}),a.sale&&(0,t.jsxs)("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-700",children:["Venta #",a.sale.saleNumber]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-4 text-sm text-gray-500 mb-2",children:[a.customer?(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(x.A,{className:"w-4 h-4"}),a.customer.name]}):(0,t.jsxs)("span",{className:"flex items-center gap-1 text-gray-400",children:[(0,t.jsx)(x.A,{className:"w-4 h-4"}),"Sin cliente"]}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(m.A,{className:"w-4 h-4"}),U(a.createdAt)]}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(h.A,{className:"w-4 h-4"}),a.items.length," items"]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2 mb-2",children:[a.items.slice(0,3).map(e=>(0,t.jsxs)("span",{className:"text-xs px-2 py-1 rounded ".concat("SERVICE"===e.type?"bg-indigo-50 text-indigo-700":"bg-gray-100 text-gray-700"),children:["SERVICE"===e.type&&(0,t.jsx)(g.A,{className:"w-3 h-3 inline mr-1"}),e.itemName]},e.id)),a.items.length>3&&(0,t.jsxs)("span",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-500",children:["+",a.items.length-3," m\xe1s"]})]}),a.notes&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 line-clamp-1",children:[(0,t.jsx)(u.A,{className:"w-3 h-3 inline mr-1"}),a.notes]})]}),(0,t.jsxs)("div",{className:"text-right flex flex-col items-end gap-2",children:[(0,t.jsx)("div",{className:"text-xl font-bold text-gray-900",children:K(a.total)}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["DRAFT"===a.status&&(0,t.jsxs)("button",{onClick:()=>B(a.id,"APPROVED"),className:"flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200",children:[(0,t.jsx)(b.A,{className:"w-4 h-4"}),"Aprobar"]}),"APPROVED"===a.status&&(0,t.jsxs)("button",{onClick:()=>B(a.id,"IN_PROGRESS"),className:"flex items-center gap-1 px-3 py-1.5 text-sm bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200",children:[(0,t.jsx)(p.A,{className:"w-4 h-4"}),"Iniciar"]}),"IN_PROGRESS"===a.status&&(0,t.jsxs)("button",{onClick:()=>B(a.id,"READY"),className:"flex items-center gap-1 px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200",children:[(0,t.jsx)(b.A,{className:"w-4 h-4"}),"Listo"]}),r&&(0,t.jsxs)("button",{onClick:()=>{D(a),_("CASH"),H(a.total.toString()),L(!0)},className:"flex items-center gap-1 px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700",children:[(0,t.jsx)(y.A,{className:"w-4 h-4"}),"Convertir a Venta"]}),(0,t.jsx)("button",{onClick:()=>e.push("/work-orders/".concat(a.id)),className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded",children:(0,t.jsx)(j.A,{className:"w-5 h-5"})})]})]})]})},a.id)})})})]})}),F&&O&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[(0,t.jsxs)("div",{className:"p-6",children:[(0,t.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["Convertir OT #",O.number," a Venta"]}),(0,t.jsxs)("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Total:"}),(0,t.jsx)("span",{className:"font-bold text-gray-900",children:K(O.total)})]}),O.customer&&(0,t.jsxs)("div",{className:"flex justify-between text-sm mt-1",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Cliente:"}),(0,t.jsx)("span",{className:"text-gray-900",children:O.customer.name})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"M\xe9todo de Pago"}),(0,t.jsxs)("select",{value:V,onChange:e=>_(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[(0,t.jsx)("option",{value:"CASH",children:"Efectivo"}),(0,t.jsx)("option",{value:"YAPE",children:"Yape"}),(0,t.jsx)("option",{value:"PLIN",children:"Plin"}),(0,t.jsx)("option",{value:"CARD",children:"Tarjeta"}),(0,t.jsx)("option",{value:"FIADO",children:"Fiado"})]})]}),"CASH"===V&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Monto Pagado (S/)"}),(0,t.jsx)("input",{type:"number",step:"0.01",min:O.total,value:I,onChange:e=>H(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),parseFloat(I)>O.total&&(0,t.jsxs)("p",{className:"text-sm text-green-600 mt-1",children:["Vuelto: ",K(parseFloat(I)-O.total)]})]}),"FIADO"===V&&!O.customer&&(0,t.jsxs)("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700",children:[(0,t.jsx)(o.A,{className:"w-4 h-4 inline mr-1"}),"Esta orden no tiene cliente asignado. Se requerir\xe1 seleccionar uno."]})]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-3 px-6 py-4 bg-gray-50 rounded-b-lg",children:[(0,t.jsx)("button",{onClick:()=>{L(!1),D(null)},className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:"Cancelar"}),(0,t.jsx)("button",{onClick:J,disabled:M,className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 flex items-center gap-2",children:M?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Procesando..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(y.A,{className:"w-4 h-4"}),"Crear Venta"]})})]})]})})]}):(0,t.jsx)(n.A,{children:(0,t.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,t.jsx)("div",{className:"max-w-7xl mx-auto py-12 px-4",children:(0,t.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center",children:[(0,t.jsx)(o.A,{className:"w-12 h-12 text-yellow-600 mx-auto mb-4"}),(0,t.jsx)("h2",{className:"text-xl font-semibold text-yellow-800 mb-2",children:"M\xf3dulo de \xd3rdenes de Trabajo No Habilitado"}),(0,t.jsx)("p",{className:"text-yellow-700",children:"Contacta al administrador para habilitar esta funcionalidad."})]})})})})}},5273:(e,a,s)=>{"use strict";s.d(a,{D0:()=>i}),s(5155);var t=s(2115);let r={flags:{},isLoading:!1,error:null,lastFetched:null},l=new Set;function n(){l.forEach(e=>e())}async function o(){let e=await fetch("/api/flags",{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw Error("Error al cargar feature flags");let a=await e.json(),s={};return Array.isArray(a.flags)&&a.flags.forEach(e=>{s[e.key]=e.enabled}),s}function i(){let[,e]=(0,t.useState)({});(0,t.useEffect)(()=>{let a=()=>e({});return l.add(a),()=>{l.delete(a)}},[]),(0,t.useEffect)(()=>{(!r.lastFetched||Date.now()-r.lastFetched>3e5)&&!r.isLoading&&a()},[]);let a=(0,t.useCallback)(async()=>{if(!r.isLoading){r={...r,isLoading:!0,error:null},n();try{r={flags:await o(),isLoading:!1,error:null,lastFetched:Date.now()}}catch(e){r={...r,isLoading:!1,error:e instanceof Error?e.message:"Error desconocido"}}n()}},[]),s=(0,t.useCallback)(e=>{var a;return null!==(a=r.flags[e])&&void 0!==a&&a},[]),i=(0,t.useCallback)(e=>!s(e),[s]),c=(0,t.useCallback)(async()=>{r={...r,lastFetched:null},await a()},[a]);return{isOn:s,isOff:i,isLoading:r.isLoading,error:r.error,refetch:c,allFlags:r.flags}}}},e=>{var a=a=>e(e.s=a);e.O(0,[814,8173,9121,9445,8441,1517,7358],()=>a(7627)),_N_E=e.O()}]);