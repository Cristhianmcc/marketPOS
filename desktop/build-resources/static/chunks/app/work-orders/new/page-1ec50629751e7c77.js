(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[718],{7188:(e,s,t)=>{Promise.resolve().then(t.bind(t,9328))},7364:(e,s,t)=>{"use strict";t.d(s,{A:()=>a});let a=(0,t(7401).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},1594:(e,s,t)=>{"use strict";t.d(s,{A:()=>a});let a=(0,t(7401).A)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},7780:(e,s,t)=>{"use strict";t.d(s,{A:()=>a});let a=(0,t(7401).A)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},1466:(e,s,t)=>{"use strict";t.d(s,{A:()=>a});let a=(0,t(7401).A)("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},2792:(e,s,t)=>{"use strict";t.d(s,{A:()=>a});let a=(0,t(7401).A)("wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z",key:"1ngwbx"}]])},9328:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>y});var a=t(5155),r=t(2115),l=t(6046),i=t(9445),n=t(7364),d=t(1466),c=t(719),o=t(853),u=t(2792);let m=(0,t(7401).A)("calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);var x=t(5686),h=t(1594),p=t(7780),g=t(814);function y(){let e=(0,l.useRouter)(),[s,t]=(0,r.useState)(!1),[y,b]=(0,r.useState)(!1),[j,f]=(0,r.useState)(""),[v,N]=(0,r.useState)(""),[w,k]=(0,r.useState)(0),[C,A]=(0,r.useState)([]),[I,P]=(0,r.useState)([]),[S,E]=(0,r.useState)([]),[O,F]=(0,r.useState)([]),[M,R]=(0,r.useState)(""),[q,z]=(0,r.useState)(""),[D,L]=(0,r.useState)(!1),[T,V]=(0,r.useState)(!1);(0,r.useEffect)(()=>{_()},[]);let _=async()=>{t(!0);try{let[e,s,t]=await Promise.all([fetch("/api/customers"),fetch("/api/products?includeUnits=true"),fetch("/api/services")]);if(e.ok){let s=await e.json();P(s.customers||s.data||[])}if(s.ok){let e=await s.json(),t=(e.products||e.data||[]).map(e=>{var s,t;return{id:e.id,storeProductId:e.storeProductId||e.id,name:e.name||(null===(s=e.product)||void 0===s?void 0:s.name),content:e.content||(null===(t=e.product)||void 0===t?void 0:t.content),price:e.price,stock:e.stock,units:e.units||[]}});E(t)}if(t.ok){let e=await t.json();F(e.data||[])}}catch(e){console.error("Error loading data:",e)}finally{t(!1)}},B=(e,s)=>{let t=s?e.units.find(e=>e.id===s):null,a=t?t.price:e.price,r=t?t.conversionFactor:1;A([...C,{tempId:"temp-".concat(Date.now()),type:"PRODUCT",storeProductId:e.storeProductId,itemName:e.name,itemContent:e.content||void 0,unitIdUsed:s,quantityOriginal:1,quantityBase:r,conversionFactor:r,unitPrice:a,subtotal:a,notes:"",selectedProduct:e}]),L(!1),R("")},U=e=>{A([...C,{tempId:"temp-".concat(Date.now()),type:"SERVICE",serviceId:e.id,itemName:e.name,quantityOriginal:1,quantityBase:1,conversionFactor:1,unitPrice:e.basePrice,subtotal:e.basePrice,notes:"",selectedService:e}]),V(!1),z("")},G=(e,s)=>{A(C.map(t=>{if(t.tempId!==e)return t;let a=s*t.conversionFactor;return{...t,quantityOriginal:s,quantityBase:a,subtotal:s*t.unitPrice}}))},H=(e,s)=>{A(C.map(t=>t.tempId!==e?t:{...t,unitPrice:s,subtotal:t.quantityOriginal*s}))},J=(e,s)=>{A(C.map(t=>t.tempId===e?{...t,notes:s}:t))},$=e=>{A(C.filter(s=>s.tempId!==e))},K=C.reduce((e,s)=>e+s.subtotal,0),Q=async s=>{if(0===C.length){g.oR.error("Agrega al menos un item");return}b(!0);try{let t={customerId:j||null,status:s?"DRAFT":"APPROVED",notes:v||null,discount:w,items:C.map(e=>({type:e.type,storeProductId:e.storeProductId||null,serviceId:e.serviceId||null,itemName:e.itemName,itemContent:e.itemContent||null,unitIdUsed:e.unitIdUsed||null,quantityOriginal:e.quantityOriginal,conversionFactor:e.conversionFactor,unitPrice:e.unitPrice,notes:e.notes||null}))},a=await fetch("/api/work-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let e=await a.json();throw Error(e.error||"Error al guardar")}let r=await a.json();g.oR.success("Orden #".concat(r.data.number," creada exitosamente")),e.push("/work-orders")}catch(e){g.oR.error(e.message||"Error al crear orden")}finally{b(!1)}},W=S.filter(e=>e.name.toLowerCase().includes(M.toLowerCase())||e.content&&e.content.toLowerCase().includes(M.toLowerCase())),X=O.filter(e=>e.name.toLowerCase().includes(q.toLowerCase())),Y=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e);return s?(0,a.jsx)(i.A,{children:(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}):(0,a.jsxs)(i.A,{children:[(0,a.jsx)(g.l$,{position:"top-right",richColors:!0}),(0,a.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,a.jsxs)("div",{className:"max-w-5xl mx-auto py-6 px-4 sm:px-6 lg:px-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,a.jsx)("button",{onClick:()=>e.push("/work-orders"),className:"p-2 hover:bg-gray-100 rounded-lg",children:(0,a.jsx)(n.A,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Nueva Orden de Trabajo"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Cotizaci\xf3n o pedido especial"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,a.jsxs)("h2",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"w-5 h-5 text-blue-600"}),"Cliente (Opcional)"]}),(0,a.jsxs)("select",{value:j,onChange:e=>f(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[(0,a.jsx)("option",{value:"",children:"Sin cliente asignado"}),I.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," ",e.phone?"(".concat(e.phone,")"):""]},e.id))]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,a.jsx)("h2",{className:"font-medium text-gray-900 mb-3",children:"Items de la Orden"}),(0,a.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsxs)("button",{onClick:()=>{L(!D),V(!1)},className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100",children:[(0,a.jsx)(c.A,{className:"w-4 h-4"}),"Agregar Producto"]}),D&&(0,a.jsxs)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 max-h-64 overflow-auto",children:[(0,a.jsx)("div",{className:"p-2 border-b border-gray-100",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(o.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,a.jsx)("input",{type:"text",placeholder:"Buscar producto...",value:M,onChange:e=>R(e.target.value),autoFocus:!0,className:"w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"})]})}),(0,a.jsx)("div",{className:"max-h-48 overflow-auto",children:0===W.length?(0,a.jsx)("p",{className:"p-4 text-sm text-gray-500 text-center",children:"No se encontraron productos"}):W.slice(0,20).map(e=>(0,a.jsxs)("div",{className:"border-b border-gray-50 last:border-0",children:[(0,a.jsxs)("button",{onClick:()=>B(e),className:"w-full text-left px-4 py-2 hover:bg-gray-50 flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),e.content&&(0,a.jsx)("div",{className:"text-xs text-gray-500",children:e.content})]}),(0,a.jsx)("span",{className:"text-sm font-medium text-blue-600",children:Y(e.price)})]}),e.units.length>0&&(0,a.jsx)("div",{className:"px-4 pb-2 flex gap-1 flex-wrap",children:e.units.map(s=>(0,a.jsxs)("button",{onClick:()=>B(e,s.id),className:"text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:[s.symbol||s.code," (",Y(s.price),")"]},s.id))})]},e.id))})]})]}),(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsxs)("button",{onClick:()=>{V(!T),L(!1)},className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100",children:[(0,a.jsx)(u.A,{className:"w-4 h-4"}),"Agregar Servicio"]}),T&&(0,a.jsxs)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 max-h-64 overflow-auto",children:[(0,a.jsx)("div",{className:"p-2 border-b border-gray-100",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(o.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,a.jsx)("input",{type:"text",placeholder:"Buscar servicio...",value:q,onChange:e=>z(e.target.value),autoFocus:!0,className:"w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"})]})}),(0,a.jsx)("div",{className:"max-h-48 overflow-auto",children:0===X.length?(0,a.jsx)("p",{className:"p-4 text-sm text-gray-500 text-center",children:"No se encontraron servicios"}):X.map(e=>(0,a.jsx)("button",{onClick:()=>U(e),className:"w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-50 last:border-0",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),e.description&&(0,a.jsx)("div",{className:"text-xs text-gray-500",children:e.description})]}),(0,a.jsx)("span",{className:"text-sm font-medium text-indigo-600",children:Y(e.basePrice)})]})},e.id))})]})]})]}),0===C.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)(m,{className:"w-10 h-10 mx-auto mb-2 text-gray-300"}),(0,a.jsx)("p",{children:"No hay items agregados"}),(0,a.jsx)("p",{className:"text-sm",children:"Agrega productos o servicios para cotizar"})]}):(0,a.jsx)("div",{className:"space-y-3",children:C.map(e=>(0,a.jsx)("div",{className:"p-3 rounded-lg border ".concat("SERVICE"===e.type?"bg-indigo-50 border-indigo-200":"bg-gray-50 border-gray-200"),children:(0,a.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:["SERVICE"===e.type?(0,a.jsx)(u.A,{className:"w-4 h-4 text-indigo-600"}):(0,a.jsx)(c.A,{className:"w-4 h-4 text-blue-600"}),(0,a.jsx)("span",{className:"font-medium text-gray-900",children:e.itemName}),e.itemContent&&(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:["(",e.itemContent,")"]})]}),(0,a.jsxs)("div",{className:"mt-2 flex flex-wrap items-center gap-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("label",{className:"text-xs text-gray-500",children:"Cant:"}),(0,a.jsx)("input",{type:"number",min:"0.01",step:"0.01",value:e.quantityOriginal,onChange:s=>G(e.tempId,parseFloat(s.target.value)||0),className:"w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("label",{className:"text-xs text-gray-500",children:"Precio:"}),(0,a.jsx)("input",{type:"number",min:"0",step:"0.01",value:e.unitPrice,onChange:s=>H(e.tempId,parseFloat(s.target.value)||0),className:"w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]})]}),(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("input",{type:"text",placeholder:"Notas (medidas, especificaciones...)",value:e.notes,onChange:s=>J(e.tempId,s.target.value),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})})]}),(0,a.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,a.jsx)("span",{className:"font-bold text-gray-900",children:Y(e.subtotal)}),(0,a.jsx)("button",{onClick:()=>$(e.tempId),className:"p-1 text-red-500 hover:bg-red-100 rounded",children:(0,a.jsx)(x.A,{className:"w-4 h-4"})})]})]})},e.tempId))})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,a.jsx)("h2",{className:"font-medium text-gray-900 mb-3",children:"Notas Generales"}),(0,a.jsx)("textarea",{value:v,onChange:e=>N(e.target.value),rows:3,placeholder:"Instrucciones especiales, detalles del trabajo, fecha de entrega...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),(0,a.jsx)("div",{className:"lg:col-span-1",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 sticky top-4",children:[(0,a.jsx)("h2",{className:"font-medium text-gray-900 mb-4",children:"Resumen"}),(0,a.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Items:"}),(0,a.jsx)("span",{className:"font-medium",children:C.length})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Subtotal:"}),(0,a.jsx)("span",{className:"font-medium",children:Y(K)})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Descuento:"}),(0,a.jsx)("input",{type:"number",min:"0",step:"0.01",value:w,onChange:e=>k(parseFloat(e.target.value)||0),className:"w-24 px-2 py-1 text-sm text-right border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsxs)("div",{className:"pt-3 border-t border-gray-200 flex justify-between",children:[(0,a.jsx)("span",{className:"font-medium text-gray-900",children:"Total:"}),(0,a.jsx)("span",{className:"text-xl font-bold text-gray-900",children:Y(K-w)})]})]}),0===C.length&&(0,a.jsxs)("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700",children:[(0,a.jsx)(h.A,{className:"w-4 h-4 inline mr-1"}),"Agrega items para poder guardar"]}),(0,a.jsxs)("div",{className:"mt-6 space-y-2",children:[(0,a.jsxs)("button",{onClick:()=>Q(!0),disabled:y||0===C.length,className:"w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 flex items-center justify-center gap-2",children:[(0,a.jsx)(p.A,{className:"w-4 h-4"}),"Guardar como Borrador"]}),(0,a.jsx)("button",{onClick:()=>Q(!1),disabled:y||0===C.length,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-2",children:y?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Guardando..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(p.A,{className:"w-4 h-4"}),"Guardar y Aprobar"]})})]})]})})]})]})})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[814,8173,9121,9445,8441,1517,7358],()=>s(7188)),_N_E=e.O()}]);