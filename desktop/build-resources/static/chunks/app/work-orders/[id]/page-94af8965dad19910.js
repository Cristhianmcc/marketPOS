(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5734],{808:(e,s,a)=>{Promise.resolve().then(a.bind(a,7955))},7364:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},2423:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]])},8867:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},1594:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},3580:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]])},9191:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]])},1466:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},2792:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(7401).A)("wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z",key:"1ngwbx"}]])},7955:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>f});var t=a(5155),r=a(2115),l=a(6046),c=a(9445),d=a(1594),i=a(7364),n=a(3580),o=a(767),x=a(8474),m=a(1466),h=a(719),u=a(2792),g=a(4081),p=a(8867),b=a(9191),y=a(2423),j=a(814);let N={DRAFT:{label:"Borrador",color:"border-gray-400",bgColor:"bg-gray-100",textColor:"text-gray-700"},APPROVED:{label:"Aprobado",color:"border-blue-400",bgColor:"bg-blue-100",textColor:"text-blue-700"},IN_PROGRESS:{label:"En Proceso",color:"border-yellow-400",bgColor:"bg-yellow-100",textColor:"text-yellow-700"},READY:{label:"Listo",color:"border-green-400",bgColor:"bg-green-100",textColor:"text-green-700"},CLOSED:{label:"Cerrado",color:"border-purple-400",bgColor:"bg-purple-100",textColor:"text-purple-700"},CANCELLED:{label:"Cancelado",color:"border-red-400",bgColor:"bg-red-100",textColor:"text-red-700"}};function f(e){let{params:s}=e,a=(0,r.use)(s),f=(0,l.useRouter)(),[w,v]=(0,r.useState)(null),[A,C]=(0,r.useState)(!0),[E,k]=(0,r.useState)(!1),[S,R]=(0,r.useState)(!1),[P,O]=(0,r.useState)("CASH"),[D,T]=(0,r.useState)(""),[L,F]=(0,r.useState)(!1);(0,r.useEffect)(()=>{M()},[a.id]);let M=async()=>{C(!0);try{let e=await fetch("/api/work-orders/".concat(a.id));if(!e.ok){if(404===e.status){j.oR.error("Orden no encontrada"),f.push("/work-orders");return}throw Error("Error al cargar orden")}let s=await e.json();v(s.data)}catch(e){console.error("Error loading order:",e),j.oR.error("Error al cargar la orden")}finally{C(!1)}},I=async e=>{if(w){k(!0);try{let s=await fetch("/api/work-orders",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:w.id,status:e})});if(!s.ok){let e=await s.json();throw Error(e.error||"Error al actualizar")}j.oR.success("Estado actualizado a ".concat(N[e].label)),M()}catch(e){j.oR.error(e.message||"Error al actualizar estado")}finally{k(!1)}}},H=async()=>{if(w){if("CASH"===P){let e=parseFloat(D);if(isNaN(e)||e<w.total){j.oR.error("Monto pagado insuficiente");return}}F(!0);try{let e={paymentMethod:P};"CASH"===P&&(e.amountPaid=parseFloat(D));let s=await fetch("/api/work-orders/".concat(w.id,"/convert-to-sale"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){let e=await s.json();throw Error(e.error||"Error al convertir")}let a=await s.json();j.oR.success("Venta #".concat(a.data.saleNumber," creada exitosamente")),R(!1),M()}catch(e){j.oR.error(e.message||"Error al convertir orden")}finally{F(!1)}}},V=async()=>{if(w&&confirm("\xbfEst\xe1s seguro de cancelar esta orden?")){k(!0);try{let e=await fetch("/api/work-orders",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:w.id,status:"CANCELLED"})});if(!e.ok){let s=await e.json();throw Error(s.error||"Error al cancelar")}j.oR.success("Orden cancelada"),M()}catch(e){j.oR.error(e.message||"Error al cancelar")}finally{k(!1)}}},_=e=>new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e),z=e=>new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"});if(A)return(0,t.jsx)(c.A,{children:(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})});if(!w)return(0,t.jsx)(c.A,{children:(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(d.A,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),(0,t.jsx)("p",{className:"text-gray-500",children:"Orden no encontrada"})]})})});let Y=N[w.status],G=["APPROVED","IN_PROGRESS","READY"].includes(w.status)&&!w.sale,J="DRAFT"===w.status,q=!["CLOSED","CANCELLED"].includes(w.status);return(0,t.jsxs)(c.A,{children:[(0,t.jsx)(j.l$,{position:"top-right",richColors:!0}),(0,t.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,t.jsxs)("div",{className:"max-w-5xl mx-auto py-6 px-4 sm:px-6 lg:px-8",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-4 mb-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("button",{onClick:()=>f.push("/work-orders"),className:"p-2 hover:bg-gray-100 rounded-lg",children:(0,t.jsx)(i.A,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsxs)("h1",{className:"text-2xl font-bold text-gray-900",children:["OT #",w.number]}),(0,t.jsx)("span",{className:"px-3 py-1 text-sm font-medium rounded-full ".concat(Y.bgColor," ").concat(Y.textColor),children:Y.label})]}),(0,t.jsxs)("p",{className:"text-gray-500 text-sm mt-1",children:["Creada ",z(w.createdAt)]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[J&&(0,t.jsxs)("button",{onClick:()=>f.push("/work-orders/".concat(w.id,"/edit")),className:"flex items-center gap-2 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:[(0,t.jsx)(n.A,{className:"w-4 h-4"}),"Editar"]}),q&&(0,t.jsxs)("button",{onClick:V,disabled:E,className:"flex items-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg",children:[(0,t.jsx)(o.A,{className:"w-4 h-4"}),"Cancelar"]})]})]}),w.sale&&(0,t.jsx)("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(x.A,{className:"w-5 h-5 text-green-600"}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:"font-medium text-green-800",children:["Convertida a Venta #",w.sale.saleNumber]}),(0,t.jsx)("p",{className:"text-sm text-green-600",children:z(w.sale.createdAt)})]})]})}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,t.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsxs)("h2",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[(0,t.jsx)(m.A,{className:"w-5 h-5 text-blue-600"}),"Cliente"]}),w.customer?(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-medium text-gray-900",children:w.customer.name}),w.customer.phone&&(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:["Tel: ",w.customer.phone]}),w.customer.dni&&(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:["DNI: ",w.customer.dni]})]}):(0,t.jsx)("p",{className:"text-gray-500",children:"Sin cliente asignado"})]}),(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsxs)("h2",{className:"font-medium text-gray-900 mb-4 flex items-center gap-2",children:[(0,t.jsx)(h.A,{className:"w-5 h-5 text-blue-600"}),"Items (",w.items.length,")"]}),(0,t.jsx)("div",{className:"divide-y divide-gray-100",children:w.items.map(e=>(0,t.jsx)("div",{className:"py-3 first:pt-0 last:pb-0",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["SERVICE"===e.type?(0,t.jsx)(u.A,{className:"w-4 h-4 text-indigo-600"}):(0,t.jsx)(h.A,{className:"w-4 h-4 text-blue-600"}),(0,t.jsx)("span",{className:"font-medium text-gray-900",children:e.itemName}),e.itemContent&&(0,t.jsxs)("span",{className:"text-sm text-gray-500",children:["(",e.itemContent,")"]}),e.unit&&(0,t.jsx)("span",{className:"text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded",children:e.unit.symbol||e.unit.code})]}),e.notes&&(0,t.jsxs)("p",{className:"mt-1 text-sm text-gray-500 pl-6",children:[(0,t.jsx)(g.A,{className:"w-3 h-3 inline mr-1"}),e.notes]})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-500",children:[e.quantityOriginal," \xd7 ",_(e.unitPrice)]}),(0,t.jsx)("div",{className:"font-medium text-gray-900",children:_(e.subtotal)})]})]})},e.id))})]}),w.notes&&(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsxs)("h2",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[(0,t.jsx)(g.A,{className:"w-5 h-5 text-blue-600"}),"Notas"]}),(0,t.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:w.notes})]})]}),(0,t.jsxs)("div",{className:"lg:col-span-1 space-y-4",children:[(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsx)("h2",{className:"font-medium text-gray-900 mb-4",children:"Resumen"}),(0,t.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Subtotal:"}),(0,t.jsx)("span",{className:"font-medium",children:_(w.subtotal)})]}),w.discount>0&&(0,t.jsxs)("div",{className:"flex justify-between text-red-600",children:[(0,t.jsx)("span",{children:"Descuento:"}),(0,t.jsxs)("span",{children:["-",_(w.discount)]})]}),(0,t.jsxs)("div",{className:"pt-2 border-t border-gray-200 flex justify-between",children:[(0,t.jsx)("span",{className:"font-medium text-gray-900",children:"Total:"}),(0,t.jsx)("span",{className:"text-xl font-bold text-gray-900",children:_(w.total)})]})]})]}),!w.sale&&"CANCELLED"!==w.status&&(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsx)("h2",{className:"font-medium text-gray-900 mb-4",children:"Acciones"}),(0,t.jsxs)("div",{className:"space-y-2",children:["DRAFT"===w.status&&(0,t.jsxs)("button",{onClick:()=>I("APPROVED"),disabled:E,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:[(0,t.jsx)(p.A,{className:"w-4 h-4"}),"Aprobar Orden"]}),"APPROVED"===w.status&&(0,t.jsxs)("button",{onClick:()=>I("IN_PROGRESS"),disabled:E,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50",children:[(0,t.jsx)(b.A,{className:"w-4 h-4"}),"Iniciar Trabajo"]}),"IN_PROGRESS"===w.status&&(0,t.jsxs)("button",{onClick:()=>I("READY"),disabled:E,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",children:[(0,t.jsx)(p.A,{className:"w-4 h-4"}),"Marcar como Listo"]}),G&&(0,t.jsxs)("button",{onClick:()=>{O("CASH"),T(w.total.toString()),R(!0)},className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700",children:[(0,t.jsx)(x.A,{className:"w-4 h-4"}),"Convertir a Venta"]})]})]}),(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[(0,t.jsxs)("h2",{className:"font-medium text-gray-900 mb-4 flex items-center gap-2",children:[(0,t.jsx)(y.A,{className:"w-5 h-5 text-blue-600"}),"Historial"]}),(0,t.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("div",{className:"w-2 h-2 mt-1.5 rounded-full bg-blue-500"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-900",children:"Orden creada"}),(0,t.jsx)("p",{className:"text-gray-500",children:z(w.createdAt)})]})]}),w.updatedAt!==w.createdAt&&(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("div",{className:"w-2 h-2 mt-1.5 rounded-full bg-gray-400"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-900",children:"\xdaltima actualizaci\xf3n"}),(0,t.jsx)("p",{className:"text-gray-500",children:z(w.updatedAt)})]})]}),w.sale&&(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("div",{className:"w-2 h-2 mt-1.5 rounded-full bg-green-500"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-gray-900",children:"Convertida a venta"}),(0,t.jsx)("p",{className:"text-gray-500",children:z(w.sale.createdAt)})]})]})]})]})]})]})]})}),S&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[(0,t.jsxs)("div",{className:"p-6",children:[(0,t.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["Convertir OT #",w.number," a Venta"]}),(0,t.jsxs)("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Total:"}),(0,t.jsx)("span",{className:"font-bold text-gray-900",children:_(w.total)})]}),w.customer&&(0,t.jsxs)("div",{className:"flex justify-between text-sm mt-1",children:[(0,t.jsx)("span",{className:"text-gray-600",children:"Cliente:"}),(0,t.jsx)("span",{className:"text-gray-900",children:w.customer.name})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"M\xe9todo de Pago"}),(0,t.jsxs)("select",{value:P,onChange:e=>O(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[(0,t.jsx)("option",{value:"CASH",children:"Efectivo"}),(0,t.jsx)("option",{value:"YAPE",children:"Yape"}),(0,t.jsx)("option",{value:"PLIN",children:"Plin"}),(0,t.jsx)("option",{value:"CARD",children:"Tarjeta"}),(0,t.jsx)("option",{value:"FIADO",children:"Fiado"})]})]}),"CASH"===P&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Monto Pagado (S/)"}),(0,t.jsx)("input",{type:"number",step:"0.01",min:w.total,value:D,onChange:e=>T(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),parseFloat(D)>w.total&&(0,t.jsxs)("p",{className:"text-sm text-green-600 mt-1",children:["Vuelto: ",_(parseFloat(D)-w.total)]})]}),"FIADO"===P&&!w.customer&&(0,t.jsxs)("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700",children:[(0,t.jsx)(d.A,{className:"w-4 h-4 inline mr-1"}),"Esta orden no tiene cliente asignado."]})]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-3 px-6 py-4 bg-gray-50 rounded-b-lg",children:[(0,t.jsx)("button",{onClick:()=>R(!1),className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:"Cancelar"}),(0,t.jsx)("button",{onClick:H,disabled:L,className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 flex items-center gap-2",children:L?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Procesando..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.A,{className:"w-4 h-4"}),"Crear Venta"]})})]})]})})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[814,8173,9121,9445,8441,1517,7358],()=>s(808)),_N_E=e.O()}]);