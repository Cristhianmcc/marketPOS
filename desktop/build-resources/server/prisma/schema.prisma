// prisma/schema.prisma
// Compatible with PostgreSQL (dev) and MySQL (future desktop offline)

generator client {
  provider = "prisma-client-js"
}

// ✅ MÓDULO S10: Soporte para PgBouncer + migraciones directas
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Para migraciones (bypass pooler)
}

//// ENUMS

enum UserRole {
  OWNER
  CASHIER
}

enum UnitType {
  UNIT // unidad
  KG // kilogramo
}

enum MovementType {
  SALE
  PURCHASE
  ADJUSTMENT
}

enum PaymentMethod {
  CASH
  YAPE
  PLIN
  CARD
  FIADO
}

enum ReceivableStatus {
  OPEN
  PAID
  CANCELLED
}

enum StoreStatus {
  ACTIVE
  ARCHIVED
}

enum DiscountType {
  PERCENT
  AMOUNT
}

enum PromotionType {
  TWO_FOR_ONE
  PACK_PRICE
  HAPPY_HOUR
}

enum CouponType {
  PERCENT
  AMOUNT
}

enum VolumePromoType {
  FIXED_PRICE
}

enum NthPromoType {
  NTH_PERCENT // 2do al 50%, 3ro al 100%, etc.
}

enum PlanCode {
  DEMO
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELLED
}

// ✅ MÓDULO F2: Enums adicionales
enum UnitKind {
  GOODS
  SERVICES
}

enum RoundingMode {
  NONE
  ROUND
  CEIL
  FLOOR
}

enum PricingMode {
  BASE_UNIT
  SELL_UNIT_OVERRIDE
}

enum WorkOrderStatus {
  DRAFT
  APPROVED
  IN_PROGRESS
  READY
  CLOSED
  CANCELLED
}

enum WorkOrderItemType {
  PRODUCT
  SERVICE
}

enum BusinessProfile {
  BODEGA
  FERRETERIA
  TALLER
  LAVANDERIA
  POLLERIA
  HOSTAL
  BOTICA
  ACCESORIOS
}

//// MODELS

model Store {
  id              String          @id @default(cuid())
  name            String
  ruc             String?
  address         String?
  phone           String?
  status          StoreStatus     @default(ACTIVE)
  businessProfile BusinessProfile @default(BODEGA) @map("business_profile")
  isDemoStore     Boolean         @default(false) @map("is_demo_store") // ✅ MÓDULO 17.4: Demo Mode
  archivedAt      DateTime?       @map("archived_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  users              User[]
  storeProducts      StoreProduct[]
  sales              Sale[]
  shifts             Shift[]
  movements          Movement[]
  settings           StoreSettings?
  customers          Customer[] // ✅ Clientes de la tienda
  receivables        Receivable[] // ✅ Cuentas por cobrar
  promotions         Promotion[] // ✅ Promociones de la tienda
  coupons            Coupon[] // ✅ Cupones de la tienda
  categoryPromotions CategoryPromotion[] // ✅ Promociones por categoría (14.2-B)
  volumePromotions   VolumePromotion[] // ✅ Promociones por volumen (14.2-C1)
  nthPromotions      NthPromotion[] // ✅ Promociones n-ésimo con descuento (14.2-C2)
  auditLogs          AuditLog[] // ✅ MÓDULO 15: Auditoría
  featureFlags       FeatureFlag[] // ✅ MÓDULO 15: Feature Flags (Fase 2)
  operationalLimit   OperationalLimit? // ✅ MÓDULO 15: Límites Operativos (Fase 3)
  subscription       Subscription? // ✅ MÓDULO 16: Licencia y Suscripción
  payments           Payment[] // ✅ MÓDULO 16: Historial de pagos
  productsCreated    ProductMaster[]     @relation("ProductCreatedByStore") // ✅ MÓDULO 18.1: Productos creados por esta tienda

  // ✅ MÓDULO 18: Facturación Electrónica SUNAT
  sunatSettings       SunatSettings?
  electronicDocuments ElectronicDocument[]

  // ✅ MÓDULO F2: Relaciones adicionales
  categories      Category[]
  unitConversions UnitConversion[]
  sellUnitPrices  SellUnitPrice[]
  services        Service[]
  workOrders      WorkOrder[]

  // ✅ MÓDULO D8: Cloud Backups
  cloudBackups CloudBackup[]

  @@map("stores")
}

model User {
  id        String   @id @default(cuid())
  storeId   String   @map("store_id")
  email     String   @unique
  name      String
  password  String // hashed in module 2
  role      UserRole
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shifts relations
  openedShifts Shift[] @relation("ShiftOpenedBy")
  closedShifts Shift[] @relation("ShiftClosedBy")

  // Sales relation (cashier)
  sales Sale[]

  // Movements created by user
  movements Movement[]

  // Receivables created
  receivablesCreated Receivable[]        @relation("ReceivableCreatedBy")
  receivablePayments ReceivablePayment[] @relation("PaymentCreatedBy")

  // MÓDULO 15: Auditoría
  auditLogs AuditLog[]

  // ✅ MÓDULO 18.1: Productos aprobados por el usuario (opcional)
  productsApproved ProductMaster[] @relation("ProductApprovedBy")

  // ✅ MÓDULO D8: Cloud Backups subidos por usuario
  cloudBackupsUploaded CloudBackup[]

  @@index([storeId])
  @@map("users")
}

// Catálogo maestro
model ProductMaster {
  id          String   @id @default(cuid())
  barcode     String?  @unique // Nullable para productos sin código
  internalSku String   @unique @map("internal_sku")
  name        String
  brand       String?
  content     String? // Ej: "500 ml", "1 kg"
  category    String   @default("Otros")
  unitType    UnitType @map("unit_type") // ✅ unitType pertenece al producto
  imageUrl    String?  @map("image_url")

  // ✅ MÓDULO 17.2: Quick Sell POS
  isQuickSell    Boolean @default(false) @map("is_quick_sell")
  quickSellOrder Int?    @map("quick_sell_order")

  // ✅ MÓDULO 18.1: Catálogo Global + Opt-In
  isGlobal         Boolean   @default(false) @map("is_global") // visible en catálogo global
  createdByStoreId String?   @map("created_by_store_id") // tienda que lo creó (auditoría)
  approvedAt       DateTime? @map("approved_at") // opcional: aprobación por SUPERADMIN
  approvedById     String?   @map("approved_by_id") // opcional

  // ✅ MÓDULO 18.2: Normalización para fuzzy matching y dedupe asistido
  normalizedName String? @map("normalized_name") // nombre normalizado (lowercase, sin tildes)
  fingerprint    String? @map("fingerprint") // hash único: normalizedName|brand|content
  mergedIntoId   String? @map("merged_into_id") // si fue unificado en otro producto

  // ✅ MÓDULO F2: Unidad base del producto
  baseUnitId String? @map("base_unit_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  storeProducts StoreProduct[]

  // ✅ MÓDULO F2: Relación con unidad base
  baseUnit         Unit?             @relation(fields: [baseUnitId], references: [id], onDelete: SetNull)
  unitConversions  UnitConversion[]
  sellUnitPrices   SellUnitPrice[]
  promotions       Promotion[] // ✅ Promociones del producto
  nthPromotions    NthPromotion[] // ✅ Promociones n-ésimo con descuento del producto
  volumePromotions VolumePromotion[] // ✅ Promociones por volumen del producto

  // ✅ MÓDULO 18.1: Relaciones de Catálogo Global
  createdByStore Store? @relation("ProductCreatedByStore", fields: [createdByStoreId], references: [id], onDelete: SetNull)
  approvedBy     User?  @relation("ProductApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([barcode])
  @@index([name])
  @@index([internalSku])
  @@index([isGlobal])
  @@index([createdByStoreId])
  @@index([normalizedName])
  @@index([fingerprint])
  @@map("products_master")
}

// Precio/stock por tienda
model StoreProduct {
  id        String @id @default(cuid())
  storeId   String @map("store_id")
  productId String @map("product_id")

  price    Decimal  @db.Decimal(10, 2)
  stock    Decimal? @db.Decimal(10, 3) // null permitido (ej: kg sin control)
  minStock Decimal? @map("min_stock") @db.Decimal(10, 3)

  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)

  saleItems      SaleItem[]
  movements      Movement[]
  workOrderItems WorkOrderItem[] // ✅ MÓDULO F2: Items de órdenes de trabajo

  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
  @@map("store_products")
}

// Turnos / Corte de caja
model Shift {
  id      String @id @default(cuid())
  storeId String @map("store_id")

  openedById String  @map("opened_by")
  closedById String? @map("closed_by")

  openedAt DateTime  @default(now()) @map("opened_at")
  closedAt DateTime? @map("closed_at")

  openingCash Decimal  @map("opening_cash") @db.Decimal(10, 2)
  closingCash Decimal? @map("closing_cash") @db.Decimal(10, 2)

  expectedCash Decimal? @map("expected_cash") @db.Decimal(10, 2)
  difference   Decimal? @db.Decimal(10, 2)

  notes  String?
  isDemo Boolean @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  openedBy User  @relation("ShiftOpenedBy", fields: [openedById], references: [id], onDelete: Cascade)
  closedBy User? @relation("ShiftClosedBy", fields: [closedById], references: [id], onDelete: SetNull)

  sales              Sale[]
  receivablePayments ReceivablePayment[] // ✅ Pagos de FIADO en este turno

  @@index([storeId, openedAt])
  @@map("shifts")
}

// Venta (cabecera)
model Sale {
  id         String  @id @default(cuid())
  storeId    String  @map("store_id")
  userId     String  @map("user_id") // cashier
  shiftId    String? @map("shift_id")
  customerId String? @map("customer_id") // ✅ Para ventas FIADO

  saleNumber Int @map("sale_number") // correlativo por tienda

  subtotal Decimal @db.Decimal(10, 2) // total sin impuestos (o antes de tax)
  tax      Decimal @db.Decimal(10, 2) // puede ser 0
  total    Decimal @db.Decimal(10, 2)

  // Descuentos (Módulo 14)
  discountTotal       Decimal @default(0) @map("discount_total") @db.Decimal(10, 2)
  totalBeforeDiscount Decimal @default(0) @map("total_before_discount") @db.Decimal(10, 2)

  // Cupones (Módulo 14.2-A) - Snapshot
  couponCode        String?     @map("coupon_code")
  couponType        CouponType? @map("coupon_type")
  couponValue       Decimal?    @map("coupon_value") @db.Decimal(10, 2)
  couponDiscount    Decimal     @default(0) @map("coupon_discount") @db.Decimal(10, 2)
  totalBeforeCoupon Decimal     @default(0) @map("total_before_coupon") @db.Decimal(10, 2)

  paymentMethod PaymentMethod @map("payment_method")
  amountPaid    Decimal?      @map("amount_paid") @db.Decimal(10, 2) // efectivo
  changeAmount  Decimal?      @map("change_amount") @db.Decimal(10, 2) // vuelto

  printedAt DateTime? @map("printed_at")

  isDemo Boolean @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shift    Shift?    @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  items      SaleItem[]
  receivable Receivable? // ✅ Relación uno a uno con cuenta por cobrar
  workOrder  WorkOrder? // ✅ MÓDULO F2: Orden de trabajo asociada

  // ✅ MÓDULO 18: Documento electrónico asociado
  electronicDocuments ElectronicDocument[]

  @@unique([storeId, saleNumber])
  @@index([storeId, createdAt])
  @@index([customerId])
  @@index([shiftId]) // MÓDULO S4: Reportes por turno
  @@map("sales")
}

// Detalle de venta (snapshot)
model SaleItem {
  id             String  @id @default(cuid())
  saleId         String  @map("sale_id")
  storeProductId String? @map("store_product_id") // Nullable para servicios

  // Snapshot para que el ticket histórico no cambie si editas el producto luego
  productName    String   @map("product_name")
  productContent String?  @map("product_content")
  unitType       UnitType @map("unit_type")

  quantity  Decimal @db.Decimal(10, 3)
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  // Descuentos (Módulo 14)
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal?      @map("discount_value") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalLine      Decimal       @default(0) @map("total_line") @db.Decimal(10, 2)

  // Promociones (Módulo 14.1) - Snapshot
  promotionType     PromotionType? @map("promotion_type")
  promotionName     String?        @map("promotion_name")
  promotionDiscount Decimal        @default(0) @map("promotion_discount") @db.Decimal(10, 2)

  // Promociones por Categoría (Módulo 14.2-B) - Snapshot
  categoryPromoName     String?       @map("category_promo_name")
  categoryPromoType     DiscountType? @map("category_promo_type")
  categoryPromoDiscount Decimal       @default(0) @map("category_promo_discount") @db.Decimal(10, 2)

  // Promociones por Volumen (Módulo 14.2-C1) - Snapshot
  volumePromoName     String?  @map("volume_promo_name")
  volumePromoQty      Int?     @map("volume_promo_qty")
  volumePromoDiscount Decimal  @default(0) @map("volume_promo_discount") @db.Decimal(10, 2)
  // Promociones N-ésimo con Descuento (Módulo 14.2-C2) - Snapshot
  nthPromoName        String?  @map("nth_promo_name")
  nthPromoQty         Int?     @map("nth_promo_qty")
  nthPromoPercent     Decimal? @map("nth_promo_percent") @db.Decimal(5, 2)
  nthPromoDiscount    Decimal  @default(0) @map("nth_promo_discount") @db.Decimal(10, 2)

  // ✅ MÓDULO F2: Servicios y unidades de venta
  serviceId     String? @map("service_id")
  isService     Boolean @default(false) @map("is_service")
  unitSunatCode String? @map("unit_sunat_code")
  unitSymbol    String? @map("unit_symbol")
  unitCodeUsed  String? @map("unit_code_used")

  // ✅ MÓDULO F2.3: Snapshot de precio por presentación
  quantityOriginal     Decimal?     @map("quantity_original") @db.Decimal(10, 3)
  quantityBase         Decimal?     @map("quantity_base") @db.Decimal(10, 3)
  conversionFactorUsed Decimal?     @map("conversion_factor_used") @db.Decimal(12, 6)
  pricingMode          PricingMode? @map("pricing_mode")
  sellUnitPriceApplied Decimal?     @map("sell_unit_price_applied") @db.Decimal(10, 2)

  sale         Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct? @relation(fields: [storeProductId], references: [id], onDelete: Cascade)
  service      Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([saleId])
  @@index([storeProductId])
  @@index([serviceId])
  @@map("sale_items")
}

// Movimientos (inventario / auditoría)
model Movement {
  id             String       @id @default(cuid())
  storeId        String       @map("store_id")
  storeProductId String       @map("store_product_id")
  type           MovementType

  quantity  Decimal  @db.Decimal(10, 3)
  unitPrice Decimal? @map("unit_price") @db.Decimal(10, 2)
  total     Decimal? @db.Decimal(10, 2)

  notes       String?
  createdById String? @map("created_by")
  isDemo      Boolean @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store        Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([storeProductId, createdAt])
  @@map("movements")
}

// Configuración por tienda (ticket, impuestos, etc.)
model StoreSettings {
  id      String @id @default(cuid())
  storeId String @unique @map("store_id")

  // Configuración de ticket
  ticketFooter      String? @map("ticket_footer") @db.Text
  ticketHeaderLine1 String? @map("ticket_header_line1") @db.VarChar(100) // ej: "Bodega X"
  ticketHeaderLine2 String? @map("ticket_header_line2") @db.VarChar(100) // ej: "RUC: ..."
  taxRate           Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)

  // ✅ MÓDULO 16.2: Onboarding
  onboardingCompletedAt DateTime?     @map("onboarding_completed_at")
  onboardingStep        Int           @default(0) @map("onboarding_step") // 0-6
  onboardingDismissedAt DateTime?     @map("onboarding_dismissed_at")
  defaultPaymentMethod  PaymentMethod @default(CASH) @map("default_payment_method")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("store_settings")
}

// ✅ MÓDULO 12: CLIENTES + FIADO

// Clientes
model Customer {
  id      String  @id @default(cuid())
  storeId String  @map("store_id")
  name    String
  phone   String?
  dni     String?
  notes   String?
  active  Boolean @default(true)
  isDemo  Boolean @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sales       Sale[]
  receivables Receivable[]
  workOrders  WorkOrder[] // ✅ MÓDULO F2: Órdenes de trabajo

  @@index([storeId, name])
  @@map("customers")
}

// Cuenta por cobrar (una por venta FIADO)
model Receivable {
  id             String           @id @default(cuid())
  storeId        String           @map("store_id")
  customerId     String           @map("customer_id")
  saleId         String           @unique @map("sale_id") // ✅ Uno a uno
  originalAmount Decimal          @map("original_amount") @db.Decimal(10, 2)
  balance        Decimal          @db.Decimal(10, 2) // Saldo pendiente
  status         ReceivableStatus @default(OPEN)
  createdById    String           @map("created_by")
  isDemo         Boolean          @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store     Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer  Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sale      Sale                @relation(fields: [saleId], references: [id], onDelete: Cascade)
  createdBy User                @relation("ReceivableCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  payments  ReceivablePayment[]

  @@index([storeId, status])
  @@index([customerId])
  @@map("receivables")
}

// Pagos de cuentas por cobrar (abonos)
model ReceivablePayment {
  id           String        @id @default(cuid())
  storeId      String        @map("store_id")
  receivableId String        @map("receivable_id")
  shiftId      String        @map("shift_id") // ✅ Turno en el que se cobró
  amount       Decimal       @db.Decimal(10, 2)
  method       PaymentMethod // CASH, YAPE, PLIN, CARD
  notes        String?
  createdById  String        @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")

  receivable Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  shift      Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  createdBy  User       @relation("PaymentCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([receivableId])
  @@index([shiftId])
  @@index([storeId, createdAt])
  @@map("receivable_payments")
}

// Promociones (2x1, pack price, happy hour, fechas especiales)
model Promotion {
  id      String        @id @default(cuid())
  storeId String        @map("store_id")
  type    PromotionType
  name    String
  active  Boolean       @default(true)

  // Producto objetivo
  productId String? @map("product_id")

  // Reglas de cantidad
  minQty Int? @map("min_qty")

  // Pack price
  packPrice Decimal? @map("pack_price") @db.Decimal(10, 2)

  // Happy hour
  happyStart DateTime? @map("happy_start")
  happyEnd   DateTime? @map("happy_end")
  happyPrice Decimal?  @map("happy_price") @db.Decimal(10, 2)

  // Vigencia general (fechas especiales)
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  isDemo   Boolean   @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([productId])
  @@map("promotions")
}

// Cupones por código (NAVIDAD10, MAMA5, etc.)
model Coupon {
  id        String     @id @default(cuid())
  storeId   String     @map("store_id")
  code      String
  type      CouponType
  value     Decimal    @db.Decimal(10, 2) // 10 (%) o 5.00 (S/)
  minTotal  Decimal?   @map("min_total") @db.Decimal(10, 2) // mínimo de compra
  startsAt  DateTime?  @map("starts_at")
  endsAt    DateTime?  @map("ends_at")
  maxUses   Int?       @map("max_uses") // null = ilimitado
  usesCount Int        @default(0) @map("uses_count")
  active    Boolean    @default(true)
  isDemo    Boolean    @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, code])
  @@index([storeId, active])
  @@map("coupons")
}

// Promociones por Categoría (Módulo 14.2-B)
model CategoryPromotion {
  id       String       @id @default(cuid())
  storeId  String       @map("store_id")
  name     String
  category String // coincide con ProductMaster.category (case-insensitive)
  type     DiscountType // PERCENT | AMOUNT
  value    Decimal      @db.Decimal(10, 2) // 10 (%) o 1.00 (S/)

  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  active   Boolean   @default(true)
  isDemo   Boolean   @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  maxDiscountPerItem Decimal? @map("max_discount_per_item") @db.Decimal(10, 2) // opcional: tope por item

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([storeId, category])
  @@map("category_promotions")
}

// Promociones por Volumen / Pack Fijo (Módulo 14.2-C1)
model VolumePromotion {
  id          String          @id @default(cuid())
  storeId     String          @map("store_id")
  name        String
  productId   String          @map("product_id")
  type        VolumePromoType
  requiredQty Int             @map("required_qty") // Ej: 3
  packPrice   Decimal         @db.Decimal(10, 2) // Ej: 5.00

  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  active   Boolean   @default(true)
  isDemo   Boolean   @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([storeId, productId])
  @@map("volume_promotions")
}

// Promociones N-ésimo con Descuento (Módulo 14.2-C2)
model NthPromotion {
  id        String @id @default(cuid())
  storeId   String @map("store_id")
  name      String
  productId String @map("product_id")

  type       NthPromoType
  nthQty     Int          @map("nth_qty") // N (2 = segundo, 3 = tercero)
  percentOff Decimal      @map("percent_off") @db.Decimal(5, 2) // 50.00, 100.00, etc.

  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")
  active   Boolean   @default(true)
  isDemo   Boolean   @default(false) @map("is_demo") // ✅ MÓDULO 17.4: Demo Mode isolation

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store   Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product ProductMaster @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([storeId, active])
  @@index([storeId, productId])
  @@map("nth_promotions")
}

//// MÓDULO 15 — AUDITORÍA

enum AuditSeverity {
  INFO
  WARN
  ERROR
}

enum AuditEntityType {
  SALE
  SHIFT
  COUPON
  PROMOTION
  STORE
  CUSTOMER
  RECEIVABLE
  USER
  PRODUCT
  RESTORE
  SYSTEM
  SUBSCRIPTION // MÓDULO 16
  PAYMENT // MÓDULO 16
  CATALOG // ✅ MÓDULO 18.1: Acciones del catálogo global
  SUNAT // ✅ MÓDULO 18: Facturación electrónica
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  storeId String? @map("store_id") // nullable para acciones SUPERADMIN globales
  userId  String? @map("user_id") // nullable si es sistema

  action     String // SALE_CHECKOUT_SUCCESS, SHIFT_OPENED, etc.
  entityType AuditEntityType @map("entity_type")
  entityId   String?         @map("entity_id") // nullable
  severity   AuditSeverity   @default(INFO)

  meta      Json? // Datos adicionales sin info sensible
  ip        String? // IP del request
  userAgent String? @map("user_agent") // User-Agent del request

  store Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([severity, createdAt]) // MÓDULO S4: Alertas por fecha
  @@index([entityType, entityId])
  @@map("audit_logs")
}

//// MÓDULO 15 — FEATURE FLAGS (Fase 2)

enum FeatureFlagKey {
  ALLOW_FIADO
  ALLOW_COUPONS
  ENABLE_PROMOTIONS
  ENABLE_VOLUME_PROMOS
  ENABLE_NTH_PROMOS
  ENABLE_CATEGORY_PROMOS
  ENABLE_SUNAT // ✅ MÓDULO 18: Facturación Electrónica
  // ✅ MÓDULO F2: Feature Flags adicionales
  ENABLE_ADVANCED_UNITS
  ENABLE_CONVERSIONS
  ENABLE_SERVICES
  ENABLE_WORK_ORDERS
  ENABLE_RESERVATIONS
  ENABLE_BATCH_EXPIRY
  ENABLE_SELLUNIT_PRICING
}

model FeatureFlag {
  id        String         @id @default(cuid())
  storeId   String         @map("store_id")
  key       FeatureFlagKey
  enabled   Boolean        @default(false) // ✅ Default seguro
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, key]) // Una flag por tienda
  @@index([storeId])
  @@map("feature_flags")
}

//// MÓDULO 15 — FASE 3: LÍMITES OPERATIVOS

model OperationalLimit {
  id      String @id @default(cuid())
  storeId String @unique @map("store_id")

  // Límites de descuentos
  maxDiscountPercent      Decimal? @map("max_discount_percent") @db.Decimal(5, 2)
  maxManualDiscountAmount Decimal? @map("max_manual_discount_amount") @db.Decimal(10, 2)

  // Límites de ventas
  maxSaleTotal    Decimal? @map("max_sale_total") @db.Decimal(10, 2)
  maxItemsPerSale Int?     @map("max_items_per_sale")

  // Límites de cuentas por cobrar
  maxReceivableBalance Decimal? @map("max_receivable_balance") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("operational_limits")
}

//// MÓDULO 16 — LICENCIAS + SUSCRIPCIONES (SaaS)

model Subscription {
  id      String @id @default(cuid())
  storeId String @unique @map("store_id")

  // Plan y estado
  planCode PlanCode           @map("plan_code")
  status   SubscriptionStatus @default(TRIAL)

  // Fechas críticas
  startAt            DateTime  @default(now()) @map("start_at")
  trialEndsAt        DateTime? @map("trial_ends_at")
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  graceEndsAt        DateTime? @map("grace_ends_at")
  suspendedAt        DateTime? @map("suspended_at")
  cancelledAt        DateTime? @map("cancelled_at")

  // Precio congelado para esta tienda
  priceAmount   Decimal @map("price_amount") @db.Decimal(10, 2)
  priceCurrency String  @default("PEN") @map("price_currency")
  billingCycle  String  @default("MONTHLY") @map("billing_cycle") // MONTHLY | YEARLY

  // Notas internas (soporte)
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([storeId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id             String @id @default(cuid())
  storeId        String @map("store_id")
  subscriptionId String @map("subscription_id")

  // Monto del pago
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("PEN")

  // Registro del pago
  paidAt    DateTime @map("paid_at")
  method    String // YAPE | PLIN | TRANSFER | CARD | etc
  reference String? // Número de operación
  status    String   @default("CONFIRMED") // CONFIRMED | REJECTED | PENDING

  // Auditoría: quién registró el pago
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")

  store        Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([subscriptionId])
  @@map("payments")
}

//// MÓDULO 18 — FACTURACIÓN ELECTRÓNICA SUNAT

enum SunatDocType {
  FACTURA
  BOLETA
  NOTA_CREDITO
  NOTA_DEBITO
  SUMMARY // Resumen Diario (RC)
  VOIDED // Comunicación de Baja (RA)
}

enum SunatStatus {
  DRAFT // Creado, aún no procesado
  PENDING // Pendiente de envío
  XML_BUILT // XML generado
  SIGNED // XML firmado
  SENT // Enviado a SUNAT
  ACCEPTED // Aceptado por SUNAT
  REJECTED // Rechazado por SUNAT
  OBSERVED // Aceptado con observaciones
  ERROR // Error técnico
  CANCELED // Anulado fiscalmente
}

enum SunatEnv {
  BETA
  PROD
}

enum CustomerDocType {
  DNI
  RUC
  CE
  PASSPORT
  OTHER
}

// Configuración SUNAT por tienda
model SunatSettings {
  id      String @id @default(cuid())
  storeId String @unique @map("store_id")

  env     SunatEnv @default(BETA)
  enabled Boolean  @default(false)

  // Datos del emisor
  ruc         String?
  razonSocial String? @map("razon_social")
  address     String?
  ubigeo      String?

  // Credenciales SOL (cifradas en producción)
  solUser String? @map("sol_user")
  solPass String? @map("sol_pass")

  // Certificado digital (Base64)
  certPfxBase64 String? @map("cert_pfx_base64") @db.Text
  certPassword  String? @map("cert_password")

  // ✅ MÓDULO 18.8: Onboarding steps tracking
  stepFiscalData     Boolean @default(false) @map("step_fiscal_data")
  stepSolCredentials Boolean @default(false) @map("step_sol_credentials")
  stepCertificate    Boolean @default(false) @map("step_certificate")
  stepTestSign       Boolean @default(false) @map("step_test_sign")
  stepTestBeta       Boolean @default(false) @map("step_test_beta")

  // ✅ MÓDULO 18.8: Preferencias de emisión
  autoEmitBoleta Boolean @default(true) @map("auto_emit_boleta")
  allowFactura   Boolean @default(false) @map("allow_factura")
  defaultDocType String  @default("NONE") @map("default_doc_type") // NONE, BOLETA, FACTURA

  // Series por defecto
  defaultFacturaSeries String @default("F001") @map("default_factura_series")
  defaultBoletaSeries  String @default("B001") @map("default_boleta_series")
  defaultNcSeries      String @default("FC01") @map("default_nc_series")
  defaultNdSeries      String @default("FD01") @map("default_nd_series")

  // ✅ MÓDULO 18.6: Series para Summary y Voided
  defaultSummarySeries String @default("RC01") @map("default_summary_series")
  defaultVoidedSeries  String @default("RA01") @map("default_voided_series")

  // Correlativos
  nextFacturaNumber Int @default(1) @map("next_factura_number")
  nextBoletaNumber  Int @default(1) @map("next_boleta_number")
  nextNcNumber      Int @default(1) @map("next_nc_number")
  nextNdNumber      Int @default(1) @map("next_nd_number")

  // ✅ MÓDULO 18.6: Correlativos para Summary y Voided
  nextSummaryNumber Int @default(1) @map("next_summary_number")
  nextVoidedNumber  Int @default(1) @map("next_voided_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store               Store                @relation(fields: [storeId], references: [id], onDelete: Cascade)
  electronicDocuments ElectronicDocument[]

  @@map("sunat_settings")
}

// Documento electrónico (Factura, Boleta, NC, ND, Summary, Voided)
model ElectronicDocument {
  id      String  @id @default(cuid())
  storeId String  @map("store_id")
  saleId  String? @map("sale_id") // Nullable para Summary/Voided

  // Identificación del documento
  docType    SunatDocType @map("doc_type")
  series     String
  number     Int
  fullNumber String       @map("full_number")
  issueDate  DateTime     @map("issue_date")
  currency   String       @default("PEN")

  // Cliente
  customerDocType   CustomerDocType @map("customer_doc_type")
  customerDocNumber String          @map("customer_doc_number")
  customerName      String          @map("customer_name")
  customerAddress   String?         @map("customer_address")

  // Totales
  taxable Decimal @db.Decimal(10, 2)
  igv     Decimal @db.Decimal(10, 2)
  total   Decimal @db.Decimal(10, 2)

  // Estado y respuesta SUNAT
  status          SunatStatus @default(DRAFT)
  hash            String?
  qrText          String?     @map("qr_text")
  xmlSigned       String?     @map("xml_signed") @db.Text
  cdrZip          String?     @map("cdr_zip") @db.Text
  sunatTicket     String?     @map("sunat_ticket") // Para Summary/Voided
  sunatCode       String?     @map("sunat_code")
  sunatMessage    String?     @map("sunat_message") @db.Text
  sunatResponseAt DateTime?   @map("sunat_response_at")

  // ✅ MÓDULO 18.6: Campos para Summary y Voided
  reportedInSummary Boolean @default(false) @map("reported_in_summary") // Boletas incluidas en un RC
  referenceDocId    String? @map("reference_doc_id") // Para VOIDED: doc original que se anula
  voidReason        String? @map("void_reason") // Razón de baja/anulación

  // Solo para desarrollo
  zipSentBase64 String? @map("zip_sent_base64") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sale          Sale?         @relation(fields: [saleId], references: [id], onDelete: SetNull)
  sunatSettings SunatSettings @relation(fields: [storeId], references: [storeId], onDelete: Restrict, map: "electronic_documents_sunat_settings_fkey")
  jobs          SunatJob[]

  // Referencia al documento original (para VOIDED)
  referenceDoc ElectronicDocument?  @relation("VoidedReference", fields: [referenceDocId], references: [id], onDelete: SetNull)
  voidedBy     ElectronicDocument[] @relation("VoidedReference")

  @@unique([storeId, docType, series, number])
  @@index([storeId, status])
  @@index([saleId])
  @@index([storeId, docType, issueDate]) // Para buscar boletas del día
  @@index([storeId, reportedInSummary]) // Para Summary
  @@index([storeId, issueDate]) // ✅ MÓDULO 18.10: Para listado por fecha
  @@index([fullNumber]) // ✅ MÓDULO 18.10: Para búsqueda por número
  @@index([docType]) // ✅ MÓDULO 18.10: Para filtro por tipo
  @@map("electronic_documents")
}

// Cola de trabajos SUNAT
model SunatJob {
  id         String @id @default(cuid())
  storeId    String @map("store_id")
  documentId String @map("electronic_document_id")

  type   String // SEND_CPE, SEND_SUMMARY, SEND_VOIDED, QUERY_TICKET
  status String @default("QUEUED") // QUEUED, RUNNING, DONE, FAILED

  attempts    Int       @default(0)
  lastError   String?   @map("last_error") @db.Text
  nextRunAt   DateTime? @map("next_run_at")
  lockedAt    DateTime? @map("locked_at")
  lockedBy    String?   @map("locked_by")
  completedAt DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  document ElectronicDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([status, nextRunAt])
  @@index([documentId])
  @@map("sunat_jobs")
}

// ============================================
// ✅ MÓDULO F2: Unidades, Servicios, Órdenes de Trabajo
// ============================================

// Unidades de medida (tabla global)
model Unit {
  id            String   @id @default(cuid())
  code          String   @unique
  sunatCode     String?  @unique @map("sunat_code")
  name          String
  displayName   String?  @map("display_name")
  symbol        String?
  kind          UnitKind @default(GOODS)
  allowDecimals Boolean  @default(false) @map("allow_decimals")
  precision     Int      @default(0)
  isBase        Boolean  @default(true) @map("is_base")
  active        Boolean  @default(true)
  sortOrder     Int      @default(100) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  productMasters      ProductMaster[]
  unitConversionsFrom UnitConversion[] @relation("FromUnit")
  unitConversionsTo   UnitConversion[] @relation("ToUnit")
  services            Service[]
  sellUnitPrices      SellUnitPrice[]
  workOrderItems      WorkOrderItem[]

  @@index([code])
  @@index([sunatCode])
  @@index([kind])
  @@index([active])
  @@map("units")
}

// Conversiones entre unidades
model UnitConversion {
  id              String       @id @default(cuid())
  storeId         String       @map("store_id")
  productMasterId String       @map("product_master_id")
  fromUnitId      String       @map("from_unit_id")
  toUnitId        String       @map("to_unit_id")
  factorToBase    Decimal      @map("factor_to_base") @db.Decimal(18, 6)
  roundingMode    RoundingMode @default(NONE) @map("rounding_mode")
  active          Boolean      @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productMaster ProductMaster @relation(fields: [productMasterId], references: [id], onDelete: Cascade)
  fromUnit      Unit          @relation("FromUnit", fields: [fromUnitId], references: [id], onDelete: Cascade)
  toUnit        Unit          @relation("ToUnit", fields: [toUnitId], references: [id], onDelete: Cascade)

  @@unique([storeId, productMasterId, fromUnitId, toUnitId])
  @@index([storeId])
  @@index([productMasterId])
  @@index([storeId, productMasterId])
  @@index([fromUnitId])
  @@index([toUnitId])
  @@map("unit_conversions")
}

// Precios por unidad de venta
model SellUnitPrice {
  id              String  @id @default(cuid())
  storeId         String  @map("store_id")
  productMasterId String  @map("product_master_id")
  sellUnitId      String  @map("sell_unit_id")
  price           Decimal @db.Decimal(10, 2)
  active          Boolean @default(true)
  notes           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productMaster ProductMaster @relation(fields: [productMasterId], references: [id], onDelete: Cascade)
  sellUnit      Unit          @relation(fields: [sellUnitId], references: [id], onDelete: Cascade)

  @@unique([storeId, productMasterId, sellUnitId])
  @@index([storeId])
  @@index([productMasterId])
  @@index([storeId, productMasterId])
  @@map("sell_unit_prices")
}

// Categorías de productos
model Category {
  id        String  @id @default(cuid())
  storeId   String  @map("store_id")
  name      String
  slug      String
  parentId  String? @map("parent_id")
  color     String?
  icon      String?
  sortOrder Int     @default(0) @map("sort_order")
  active    Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store    Store      @relation(fields: [storeId], references: [id], onDelete: Restrict)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([parentId])
  @@map("categories")
}

// Servicios
model Service {
  id         String  @id @default(cuid())
  storeId    String  @map("store_id")
  baseUnitId String? @map("base_unit_id")

  name    String
  price   Decimal @db.Decimal(10, 2)
  taxable Boolean @default(true)
  active  Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store          Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  baseUnit       Unit?           @relation(fields: [baseUnitId], references: [id], onDelete: SetNull)
  saleItems      SaleItem[]
  workOrderItems WorkOrderItem[]

  @@unique([storeId, name])
  @@index([storeId])
  @@index([name])
  @@map("services")
}

// Órdenes de trabajo
model WorkOrder {
  id          String          @id @default(cuid())
  storeId     String          @map("store_id")
  orderNumber Int             @map("order_number")
  customerId  String?         @map("customer_id")
  status      WorkOrderStatus @default(DRAFT)
  notes       String?

  subtotal Decimal @default(0) @db.Decimal(12, 2)
  discount Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @default(0) @db.Decimal(12, 2)

  saleId String? @unique @map("sale_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store    Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  sale     Sale?           @relation(fields: [saleId], references: [id], onDelete: SetNull)
  items    WorkOrderItem[]

  @@unique([storeId, orderNumber])
  @@index([storeId])
  @@index([status])
  @@index([customerId])
  @@map("work_orders")
}

// Items de órdenes de trabajo
model WorkOrderItem {
  id               String            @id @default(cuid())
  workOrderId      String            @map("work_order_id")
  type             WorkOrderItemType
  storeProductId   String?           @map("store_product_id")
  serviceId        String?           @map("service_id")
  itemName         String            @map("item_name")
  itemContent      String?           @map("item_content")
  unitIdUsed       String?           @map("unit_id_used")
  quantityOriginal Decimal?          @map("quantity_original") @db.Decimal(12, 4)
  quantityBase     Decimal           @map("quantity_base") @db.Decimal(12, 4)
  conversionFactor Decimal?          @map("conversion_factor") @db.Decimal(12, 6)
  unitPrice        Decimal           @map("unit_price") @db.Decimal(12, 2)
  subtotal         Decimal           @db.Decimal(12, 2)
  notes            String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workOrder    WorkOrder     @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct? @relation(fields: [storeProductId], references: [id], onDelete: SetNull)
  service      Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  unitUsed     Unit?         @relation(fields: [unitIdUsed], references: [id], onDelete: SetNull)

  @@index([workOrderId])
  @@index([storeProductId])
  @@index([serviceId])
  @@map("work_order_items")
}

//// MÓDULO D8 — CLOUD BACKUP SYNC

enum CloudBackupStatus {
  UPLOADING
  AVAILABLE
  DELETED
  FAILED
}

model CloudBackup {
  id        String   @id @default(cuid())
  storeId   String   @map("store_id")
  createdAt DateTime @default(now()) @map("created_at")

  exportedAt DateTime @map("exported_at") // fecha del backup original
  version    String // versión del formato de backup
  appVersion String   @map("app_version") // versión de la app que creó el backup
  sizeBytes  Int      @map("size_bytes")
  sha256     String // checksum del archivo
  objectKey  String   @map("object_key") // ruta en bucket S3

  status CloudBackupStatus @default(UPLOADING)

  uploadedByUserId String? @map("uploaded_by_user_id")
  notes            String?

  deletedAt DateTime? @map("deleted_at") // para auditoría cuando se borra

  store      Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  uploadedBy User? @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  @@unique([storeId, sha256]) // evitar duplicados por store
  @@index([storeId, createdAt(sort: Desc)])
  @@index([status])
  @@map("cloud_backups")
}
